name: Deploy to GitHub Pages (Static Export)

# This workflow builds a static export version for GitHub Pages
# Note: Static version has limited functionality (no API routes/database)
# For full features, use Vercel deployment

on:
  push:
    branches: [ main ]
  workflow_dispatch: # Can also run manually

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        
    - name: Install dependencies
      run: |
        cd apps/web
        npm ci
        
    - name: Create static environment file
      run: |
        cd apps/web
        cat > .env.local << EOF
        # Static build environment for GitHub Pages
        NODE_ENV=production
        BUILD_STATIC=true
        NEXTAUTH_URL=https://giquina.github.io/gqcars
        NEXTAUTH_SECRET=github-pages-static-secret
        DATABASE_URL=file:../prisma/dev.db
        # Note: API routes will not work in static export
        EOF
        
    - name: Generate Prisma Client (for types only)
      run: |
        cd apps/web
        npx prisma generate || echo "Prisma generation failed, continuing..."
        
    - name: Build static export
      run: |
        cd apps/web
        BUILD_STATIC=true npm run build
        
    - name: Deploy to GitHub Pages
      uses: peaceiris/actions-gh-pages@v4
      if: github.ref == 'refs/heads/main'
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./apps/web/out
        cname: # Optional: Add custom domain here if you have one