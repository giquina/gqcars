"use strict";(()=>{var e={};e.id=76,e.ids=[76],e.modules={53524:e=>{e.exports=require("@prisma/client")},72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},39491:e=>{e.exports=require("assert")},14300:e=>{e.exports=require("buffer")},6113:e=>{e.exports=require("crypto")},82361:e=>{e.exports=require("events")},13685:e=>{e.exports=require("http")},95687:e=>{e.exports=require("https")},63477:e=>{e.exports=require("querystring")},57310:e=>{e.exports=require("url")},73837:e=>{e.exports=require("util")},59796:e=>{e.exports=require("zlib")},9025:(e,t,r)=>{r.r(t),r.d(t,{headerHooks:()=>v,originalPathname:()=>A,requestAsyncStorage:()=>l,routeModule:()=>p,serverHooks:()=>y,staticGenerationAsyncStorage:()=>m,staticGenerationBailout:()=>x});var a={};r.r(a),r.d(a,{POST:()=>POST});var s=r(15789),i=r(74902),o=r(70914),n=r(15275),c=r(92510),u=r(55231),d=r(17509);async function POST(e){try{let t=await (0,u.Z1)(d.L);if(!t)return o.Z.json({error:"Unauthorized"},{status:401});let r=await e.json(),{message:a,conversationId:s}=r,i=await c.Z.user.findUnique({where:{id:t.user.id},include:{customerProfile:!0,bookings:{take:5,orderBy:{createdAt:"desc"}}}}),p=await c.Z.driver.findMany({where:{status:"AVAILABLE"},include:{vehicle:!0}}),l=await c.Z.booking.count({where:{status:{in:["CONFIRMED","DRIVER_ASSIGNED","EN_ROUTE_TO_PICKUP","IN_PROGRESS"]}}}),m={conversationId:s||Date.now().toString(),messages:[],userProfile:i?{id:i.id,name:i.name,preferences:{preferredService:i.customerProfile?.preferredPayment,savedLocations:{home:i.customerProfile?.homeAddress,work:i.customerProfile?.workAddress},communicationPreferences:{language:"en",notifications:!0,contactMethod:"chat"}},bookingHistory:i.bookings.map(e=>({id:e.id,date:e.createdAt,service:e.serviceType,securityLevel:e.securityLevel,status:e.status}))}:void 0,systemState:{availableDrivers:p.map(e=>({id:e.id,location:{address:"London",coordinates:{lat:51.5074,lng:-.1278}},status:e.status.toLowerCase(),securityLevel:[e.siaLicense?"ENHANCED":"STANDARD"],services:["TAXI","PRIVATE_HIRE"],estimatedArrival:15})),currentDemand:l>10?"high":l>5?"medium":"low",pricing:{baseRates:{TAXI:6.5,PRIVATE_HIRE:8.5,AIRPORT_TRANSFER:10,CORPORATE:12,SECURITY:15,WEDDING:20},securityPremium:{STANDARD:1,ENHANCED:1.5,EXECUTIVE:2,VIP:3},demandMultiplier:l>10?1.5:l>5?1.2:1}}},y=await n.w.chat(a,m);if(y.actions&&y.actions.length>0)for(let e of y.actions)switch(e.type){case"quote":let t=await c.Z.booking.create({data:{bookingReference:`GQ${Date.now()}`,userId:i.id,serviceType:e.payload.service,securityLevel:e.payload.security,pickupAddress:e.payload.locations.pickup||"",destinationAddress:e.payload.locations.dropoff||"",estimatedPrice:calculatePrice(e.payload.service,e.payload.security,m.systemState.pricing),status:"PENDING",scheduledDateTime:new Date,currency:"GBP"}});y.message.content+=`

I've generated a quote for you: \xa3${t.estimatedPrice.toFixed(2)}`;break;case"security":if(e.payload.locations){let t=await n.w.getSecurityAssessment(e.payload.locations.pickup,e.payload.locations.dropoff,new Date,m);y.message.content+=`

Security Assessment:
Risk Level: ${t.overallRisk}
Recommended Security: ${t.recommendations.securityLevel}`}}return o.Z.json(y)}catch(e){return console.error("AI Chat Error:",e),o.Z.json({error:"Internal Server Error"},{status:500})}}function calculatePrice(e,t,r){let a=r.baseRates[e]||r.baseRates.TAXI,s=r.securityPremium[t]||1,i=r.demandMultiplier||1;return a*s*i}let p=new s.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/ai/chat/route",pathname:"/api/ai/chat",filename:"route",bundlePath:"app/api/ai/chat/route"},resolvedPagePath:"/workspace/apps/web/src/app/api/ai/chat/route.ts",nextConfigOutput:"",userland:a}),{requestAsyncStorage:l,staticGenerationAsyncStorage:m,serverHooks:y,headerHooks:v,staticGenerationBailout:x}=p,A="/api/ai/chat/route"}};var t=require("../../../../webpack-runtime.js");t.C(e);var __webpack_exec__=e=>t(t.s=e),r=t.X(0,[811,767,556],()=>__webpack_exec__(9025));module.exports=r})();