"use strict";(()=>{var e={id:76,ids:[76]};e.modules={72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},27790:e=>{e.exports=require("assert")},78893:e=>{e.exports=require("buffer")},84770:e=>{e.exports=require("crypto")},17702:e=>{e.exports=require("events")},32615:e=>{e.exports=require("http")},35240:e=>{e.exports=require("https")},86624:e=>{e.exports=require("querystring")},17360:e=>{e.exports=require("url")},21764:e=>{e.exports=require("util")},71568:e=>{e.exports=require("zlib")},23767:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>S,patchFetch:()=>P,requestAsyncStorage:()=>g,routeModule:()=>h,serverHooks:()=>b,staticGenerationAsyncStorage:()=>w});var o={};r.r(o),r.d(o,{POST:()=>v});var i=r(63538),s=r(30680),n=r(77144),a=r(86092);function c(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);t&&(o=o.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,o)}return r}function u(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?c(Object(r),!0).forEach((function(t){l(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):c(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}function l(e,t,r){return(t=function(e){var t=function(e,t){if("object"!==typeof e||null===e)return e;var r=e[Symbol.toPrimitive];if(void 0!==r){var o=r.call(e,t||"default");if("object"!==typeof o)return o;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"===typeof t?t:String(t)}(t))in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}const p=new class{constructor(){l(this,"apiKey",void 0),l(this,"baseUrl",void 0),l(this,"model",void 0),this.apiKey=process.env.CLAUDE_API_KEY||"",this.baseUrl=process.env.CLAUDE_API_URL||"https://api.anthropic.com/v1",this.model="claude-3-opus-20240229"}async callClaude(e,t,r){try{const o=await fetch(`${this.baseUrl}/messages`,{method:"POST",headers:{"Content-Type":"application/json","x-api-key":this.apiKey,"anthropic-version":"2023-06-01"},body:JSON.stringify({model:this.model,messages:[r?{role:"system",content:r}:null,...e.map((e=>({role:e.role,content:e.content})))].filter(Boolean),context:{conversation_id:t.conversationId,user_profile:t.userProfile,system_state:t.systemState},max_tokens:1e3})});if(!o.ok)throw new Error(`Claude API error: ${o.statusText}`);const i=await o.json();return this.processClaudeResponse(i,t)}catch(o){throw o}}processClaudeResponse(e,t){return{message:{id:e.id,role:"assistant",content:e.content,timestamp:new Date,metadata:{context:e.context,intent:e.intent,confidence:e.confidence,entities:e.entities}},actions:this.extractActions(e.content,t),context:{intent:e.intent,entities:e.entities,nextSteps:e.next_steps}}}extractActions(e,t){const r=[];return(e.toLowerCase().includes("quote")||e.toLowerCase().includes("price"))&&r.push({type:"quote",payload:{service:this.detectServiceType(e),security:this.detectSecurityLevel(e),locations:this.extractLocations(e)}}),(e.toLowerCase().includes("book")||e.toLowerCase().includes("schedule"))&&r.push({type:"book",payload:{service:this.detectServiceType(e),security:this.detectSecurityLevel(e),datetime:this.extractDateTime(e)}}),(e.toLowerCase().includes("security")||e.toLowerCase().includes("protection"))&&r.push({type:"security",payload:{level:this.detectSecurityLevel(e),concerns:this.extractSecurityConcerns(e)}}),r}detectServiceType(e){const t=e.toLowerCase();return t.includes("executive")||t.includes("luxury")?"EXECUTIVE":t.includes("airport")?"AIRPORT_TRANSFER":t.includes("corporate")?"CORPORATE":t.includes("wedding")?"WEDDING":t.includes("security")||t.includes("protection")?"SECURITY":t.includes("private")?"PRIVATE_HIRE":"TAXI"}detectSecurityLevel(e){const t=e.toLowerCase();return t.includes("vip")||t.includes("executive protection")?"VIP":t.includes("enhanced")||t.includes("close protection")?"ENHANCED":t.includes("executive")?"EXECUTIVE":"STANDARD"}extractLocations(e){const t={pickup:void 0,dropoff:void 0},r=e.match(/from\s+([^,]+?)(?=\s+to|$)/i),o=e.match(/to\s+([^,.]+)/i);return r&&(t.pickup=r[1].trim()),o&&(t.dropoff=o[1].trim()),t}extractDateTime(e){const t=new Date;if(e.toLowerCase().includes("now")||e.toLowerCase().includes("asap"))return t;if(e.toLowerCase().includes("tomorrow")){const e=new Date(t);return e.setDate(e.getDate()+1),e}}extractSecurityConcerns(e){const t=[];return e.toLowerCase().includes("night")&&t.push("Night-time travel"),(e.toLowerCase().includes("valuable")||e.toLowerCase().includes("jewelry"))&&t.push("Valuable items transport"),(e.toLowerCase().includes("profile")||e.toLowerCase().includes("celebrity"))&&t.push("High-profile client"),t}async chat(e,t){const r=[{id:Date.now().toString(),role:"user",content:e,timestamp:new Date}];return this.callClaude(r,t)}async getSecurityAssessment(e,t,r,o){const i=`Please assess the security requirements for a journey from ${e} to ${t} at ${r.toISOString()}.`,s=await this.chat(i,u(u({},o),{},{systemState:u(u({},o.systemState),{},{currentDemand:this.calculateDemand(r)})})),n={overallRisk:"low",factors:{time:0,location:0,route:0},recommendations:{securityLevel:"STANDARD",additionalMeasures:[]}};if(s.actions?.find((e=>"security"===e.type))){const e=s.actions.find((e=>"security"===e.type));n.overallRisk=this.calculateRiskLevel(e.payload),n.recommendations.securityLevel=e.payload.level,n.recommendations.additionalMeasures=e.payload.concerns}return n}calculateDemand(e){const t=e.getHours(),r=e.getDay();return t>=7&&t<=9||t>=16&&t<=18?"high":(5===r||6===r)&&t>=20?"surge":t>=9&&t<=17?"medium":"low"}calculateRiskLevel(e){const t=e.concerns?.length||0,r=e.level;return t>=3||"VIP"===r?"high":t>=1||"ENHANCED"===r?"medium":"low"}};var d=r(78825),y=r(87289),m=r(14893);async function v(e){try{const t=await(0,y.getServerSession)(m.L);if(!t)return a.NextResponse.json({error:"Unauthorized"},{status:401});const r=await e.json(),{message:o,conversationId:i}=r,s=await d.Z.user.findUnique({where:{id:t.user.id},include:{bookings:{take:5,orderBy:{createdAt:"desc"}}}}),n=await d.Z.booking.count({where:{status:{in:["CONFIRMED","DRIVER_ASSIGNED","EN_ROUTE_TO_PICKUP","IN_PROGRESS"]}}}),c={conversationId:i||Date.now().toString(),messages:[],userProfile:s?{id:s.id,name:s.name,preferences:{preferredService:"PRIVATE_HIRE",savedLocations:{home:void 0,work:void 0},communicationPreferences:{language:"en",notifications:!0,contactMethod:"chat"}},bookingHistory:s.bookings.map((e=>({id:e.id,date:e.date.toISOString(),service:e.service,pickupLocation:e.pickupLocation,destination:e.destination,status:e.status})))}:void 0,systemState:{availableDrivers:[],currentDemand:n>10?"HIGH":n>5?"MEDIUM":"LOW",pricing:{baseRates:{TAXI:6.5,PRIVATE_HIRE:8.5,AIRPORT_TRANSFER:10,CORPORATE:12,SECURITY:15,WEDDING:20},securityPremium:{STANDARD:1,ENHANCED:1.5,EXECUTIVE:2,VIP:3},demandMultiplier:n>10?1.5:n>5?1.2:1}}},u=await p.chat(o,c);if(u.actions&&u.actions.length>0)for(const e of u.actions)switch(e.type){case"quote":const t=await d.Z.booking.create({data:{userId:s.id,service:e.payload.service,serviceType:e.payload.service,securityLevel:e.payload.security,pickupLocation:e.payload.locations.pickup||"",destination:e.payload.locations.dropoff||"",totalCost:f(e.payload.service,e.payload.security,c.systemState.pricing),status:"pending",date:new Date,time:(new Date).toTimeString()}});u.message.content+=`\n\nI've generated a quote for you: \xa3${(t.totalCost||50).toFixed(2)}`;break;case"security":if(e.payload.locations){const t=await p.getSecurityAssessment(e.payload.locations.pickup,e.payload.locations.dropoff,new Date,c);u.message.content+=`\n\nSecurity Assessment:\nRisk Level: ${t.overallRisk}\nRecommended Security: ${t.recommendations.securityLevel}`}}return a.NextResponse.json(u)}catch(t){return a.NextResponse.json({error:"Internal Server Error"},{status:500})}}function f(e,t,r){return(r.baseRates[e]||r.baseRates.TAXI)*(r.securityPremium[t]||1)*(r.demandMultiplier||1)}const h=new i.AppRouteRouteModule({definition:{kind:s.x.APP_ROUTE,page:"/api/ai/chat/route",pathname:"/api/ai/chat",filename:"route",bundlePath:"app/api/ai/chat/route"},resolvedPagePath:"/mnt/c/Users/Student/Documents/Development_Projects/gqcars-main-production/apps/web/src/app/api/ai/chat/route.ts",nextConfigOutput:"",userland:o}),{requestAsyncStorage:g,staticGenerationAsyncStorage:w,serverHooks:b}=h,S="/api/ai/chat/route";function P(){return(0,n.patchFetch)({serverHooks:b,staticGenerationAsyncStorage:w})}},14893:(e,t,r)=>{r.d(t,{L:()=>l});var o=r(87567),i=r(78825),s=r(37531),n=r.n(s);function a(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);t&&(o=o.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,o)}return r}function c(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?a(Object(r),!0).forEach((function(t){u(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):a(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}function u(e,t,r){return(t=function(e){var t=function(e,t){if("object"!==typeof e||null===e)return e;var r=e[Symbol.toPrimitive];if(void 0!==r){var o=r.call(e,t||"default");if("object"!==typeof o)return o;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"===typeof t?t:String(t)}(t))in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}const l={session:{strategy:"jwt"},providers:[(0,o.Z)({name:"credentials",credentials:{email:{label:"Email",type:"email"},password:{label:"Password",type:"password"}},async authorize(e){if(!e?.email||!e?.password)return null;const t=await i.Z.user.findUnique({where:{email:e.email}});if(!t)return null;return await n().compare(e.password,t.password)?{id:t.id,email:t.email,name:t.name,role:t.role}:null}})],callbacks:{session:({session:e,token:t})=>c(c({},e),{},{user:c(c({},e.user),{},{id:t.id,role:t.role})}),jwt:({token:e,user:t})=>t?c(c({},e),{},{id:t.id,role:t.role}):e},pages:{signIn:"/auth/login"}}},78825:(e,t,r)=>{r.d(t,{Z:()=>i});const o=require("@prisma/client"),i=globalThis.prisma??new o.PrismaClient}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=t.X(0,[351,887,226],(()=>{return e=23767,t(t.s=e);var e}));module.exports=r})();