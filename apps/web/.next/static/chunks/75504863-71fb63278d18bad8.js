"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[93],{47563:function(e,r,t){t.d(r,{Z:function(){return m}});var n=t(98713),s=t(27849),a=t(71623),i=t(61688),o=t(83065),u=t(69717),c=t.n(u),l=t(3372),h=t(66456),p=t(21338),d=t(87513),f=t(49904),v=t(12061),b=t(88626),k=t(90511),x=t(29019),w=t(79116);(0,b.Y)();var _={url:h.G1,storageKey:h.Uf,autoRefreshToken:!0,persistSession:!0,detectSessionInUrl:!0,headers:h.QN,flowType:"implicit",debug:!1,hasCustomAuthorizationHeader:!1};function g(e,r,t){return y.apply(this,arguments)}function y(){return(y=(0,o.Z)(c().mark((function e(r,t,n){return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,n();case 2:return e.abrupt("return",e.sent);case 3:case"end":return e.stop()}}),e)})))).apply(this,arguments)}var m=function(){function e(r){var t,n,s=this;(0,a.Z)(this,e),this.memoryStorage=null,this.stateChangeEmitters=new Map,this.autoRefreshTicker=null,this.visibilityChangedCallback=null,this.refreshingDeferred=null,this.initializePromise=null,this.detectSessionInUrl=!0,this.hasCustomAuthorizationHeader=!1,this.suppressGetSessionWarning=!1,this.lockAcquired=!1,this.pendingInLock=[],this.broadcastChannel=null,this.logger=console.log,this.instanceID=e.nextInstanceID,e.nextInstanceID+=1,this.instanceID>0&&(0,f.jU)()&&console.warn("Multiple GoTrueClient instances detected in the same browser context. It is not an error, but this should be avoided as it may produce undefined behavior when used concurrently under the same storage key.");var i=Object.assign(Object.assign({},_),r);if(this.logDebugMessages=!!i.debug,"function"===typeof i.debug&&(this.logger=i.debug),this.persistSession=i.persistSession,this.storageKey=i.storageKey,this.autoRefreshToken=i.autoRefreshToken,this.admin=new l.Z({url:i.url,headers:i.headers,fetch:i.fetch}),this.url=i.url,this.headers=i.headers,this.fetch=(0,f.eM)(i.fetch),this.lock=i.lock||g,this.detectSessionInUrl=i.detectSessionInUrl,this.flowType=i.flowType,this.hasCustomAuthorizationHeader=i.hasCustomAuthorizationHeader,i.lock?this.lock=i.lock:(0,f.jU)()&&(null===(t=null===globalThis||void 0===globalThis?void 0:globalThis.navigator)||void 0===t?void 0:t.locks)?this.lock=x.aC:this.lock=g,this.jwks={keys:[]},this.jwks_cached_at=Number.MIN_SAFE_INTEGER,this.mfa={verify:this._verify.bind(this),enroll:this._enroll.bind(this),unenroll:this._unenroll.bind(this),challenge:this._challenge.bind(this),listFactors:this._listFactors.bind(this),challengeAndVerify:this._challengeAndVerify.bind(this),getAuthenticatorAssuranceLevel:this._getAuthenticatorAssuranceLevel.bind(this)},this.persistSession?i.storage?this.storage=i.storage:(0,f.y1)()?this.storage=v.N:(this.memoryStorage={},this.storage=(0,v._)(this.memoryStorage)):(this.memoryStorage={},this.storage=(0,v._)(this.memoryStorage)),(0,f.jU)()&&globalThis.BroadcastChannel&&this.persistSession&&this.storageKey){try{this.broadcastChannel=new globalThis.BroadcastChannel(this.storageKey)}catch(u){console.error("Failed to create a new BroadcastChannel, multi-tab state changes will not be available",u)}null===(n=this.broadcastChannel)||void 0===n||n.addEventListener("message",function(){var e=(0,o.Z)(c().mark((function e(r){return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return s._debug("received broadcast notification from other tab or client",r),e.next=3,s._notifyAllSubscribers(r.data.event,r.data.session,!1);case 3:case"end":return e.stop()}}),e)})));return function(r){return e.apply(this,arguments)}}())}this.initialize()}return(0,i.Z)(e,[{key:"_debug",value:function(){if(this.logDebugMessages){for(var e=arguments.length,r=new Array(e),t=0;t<e;t++)r[t]=arguments[t];this.logger.apply(this,["GoTrueClient@".concat(this.instanceID," (").concat(k.i,") ").concat((new Date).toISOString())].concat(r))}return this}},{key:"initialize",value:function(){var e=(0,o.Z)(c().mark((function e(){var r=this;return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!this.initializePromise){e.next=4;break}return e.next=3,this.initializePromise;case 3:case 7:return e.abrupt("return",e.sent);case 4:return this.initializePromise=(0,o.Z)(c().mark((function e(){return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,r._acquireLock(-1,(0,o.Z)(c().mark((function e(){return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,r._initialize();case 2:return e.abrupt("return",e.sent);case 3:case"end":return e.stop()}}),e)}))));case 2:return e.abrupt("return",e.sent);case 3:case"end":return e.stop()}}),e)})))(),e.next=7,this.initializePromise;case 8:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"_initialize",value:function(){var e=(0,o.Z)(c().mark((function e(){var r,t,n,s,a,i,u,l,h,d=this;return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,t=(0,f.o9)(window.location.href),n="none",!this._isImplicitGrantCallback(t)){e.next=7;break}n="implicit",e.next=11;break;case 7:return e.next=9,this._isPKCECallback(t);case 9:if(!e.sent){e.next=11;break}n="pkce";case 11:if(!(0,f.jU)()||!this.detectSessionInUrl||"none"===n){e.next=32;break}return e.next=14,this._getSessionFromURL(t,n);case 14:if(s=e.sent,a=s.data,!(i=s.error)){e.next=26;break}if(this._debug("#_initialize()","error detecting session from URL",i),!(0,p.wo)(i)){e.next=23;break}if("identity_already_exists"!==(u=null===(r=i.details)||void 0===r?void 0:r.code)&&"identity_not_found"!==u&&"single_identity_not_deletable"!==u){e.next=23;break}return e.abrupt("return",{error:i});case 23:return e.next=25,this._removeSession();case 25:return e.abrupt("return",{error:i});case 26:return l=a.session,h=a.redirectType,this._debug("#_initialize()","detected session in URL",l,"redirect type",h),e.next=30,this._saveSession(l);case 30:return setTimeout((0,o.Z)(c().mark((function e(){return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if("recovery"!==h){e.next=5;break}return e.next=3,d._notifyAllSubscribers("PASSWORD_RECOVERY",l);case 3:e.next=7;break;case 5:return e.next=7,d._notifyAllSubscribers("SIGNED_IN",l);case 7:case"end":return e.stop()}}),e)}))),0),e.abrupt("return",{error:null});case 32:return e.next=34,this._recoverAndRefresh();case 34:return e.abrupt("return",{error:null});case 37:if(e.prev=37,e.t0=e.catch(0),!(0,p.f1)(e.t0)){e.next=41;break}return e.abrupt("return",{error:e.t0});case 41:return e.abrupt("return",{error:new p.Iu("Unexpected error during initialization",e.t0)});case 42:return e.prev=42,e.next=45,this._handleVisibilityChange();case 45:return this._debug("#_initialize()","end"),e.finish(42);case 47:case"end":return e.stop()}}),e,this,[[0,37,42,47]])})));return function(){return e.apply(this,arguments)}}()},{key:"signInAnonymously",value:function(){var e=(0,o.Z)(c().mark((function e(r){var t,n,s,a,i,o,u,l;return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,(0,d.cY)(this.fetch,"POST","".concat(this.url,"/signup"),{headers:this.headers,body:{data:null!==(n=null===(t=null===r||void 0===r?void 0:r.options)||void 0===t?void 0:t.data)&&void 0!==n?n:{},gotrue_meta_security:{captcha_token:null===(s=null===r||void 0===r?void 0:r.options)||void 0===s?void 0:s.captchaToken}},xform:d.vI});case 3:if(a=e.sent,i=a.data,!(o=a.error)&&i){e.next=7;break}return e.abrupt("return",{data:{user:null,session:null},error:o});case 7:if(u=i.session,l=i.user,!i.session){e.next=14;break}return e.next=12,this._saveSession(i.session);case 12:return e.next=14,this._notifyAllSubscribers("SIGNED_IN",u);case 14:return e.abrupt("return",{data:{user:l,session:u},error:null});case 17:if(e.prev=17,e.t0=e.catch(0),!(0,p.f1)(e.t0)){e.next=21;break}return e.abrupt("return",{data:{user:null,session:null},error:e.t0});case 21:throw e.t0;case 22:case"end":return e.stop()}}),e,this,[[0,17]])})));return function(r){return e.apply(this,arguments)}}()},{key:"signUp",value:function(){var e=(0,o.Z)(c().mark((function e(r){var t,n,a,i,o,u,l,h,v,b,k,x,w,_,g,y,m,S,I;return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,!("email"in r)){e.next=18;break}if(o=r.email,u=r.password,l=r.options,h=null,v=null,"pkce"!==this.flowType){e.next=13;break}return e.next=9,(0,f.__)(this.storage,this.storageKey);case 9:b=e.sent,k=(0,s.Z)(b,2),h=k[0],v=k[1];case 13:return e.next=15,(0,d.cY)(this.fetch,"POST","".concat(this.url,"/signup"),{headers:this.headers,redirectTo:null===l||void 0===l?void 0:l.emailRedirectTo,body:{email:o,password:u,data:null!==(t=null===l||void 0===l?void 0:l.data)&&void 0!==t?t:{},gotrue_meta_security:{captcha_token:null===l||void 0===l?void 0:l.captchaToken},code_challenge:h,code_challenge_method:v},xform:d.vI});case 15:i=e.sent,e.next=26;break;case 18:if(!("phone"in r)){e.next=25;break}return x=r.phone,w=r.password,_=r.options,e.next=22,(0,d.cY)(this.fetch,"POST","".concat(this.url,"/signup"),{headers:this.headers,body:{phone:x,password:w,data:null!==(n=null===_||void 0===_?void 0:_.data)&&void 0!==n?n:{},channel:null!==(a=null===_||void 0===_?void 0:_.channel)&&void 0!==a?a:"sms",gotrue_meta_security:{captcha_token:null===_||void 0===_?void 0:_.captchaToken}},xform:d.vI});case 22:i=e.sent,e.next=26;break;case 25:throw new p.e_("You must provide either an email or phone number and a password");case 26:if(y=(g=i).data,!(m=g.error)&&y){e.next=29;break}return e.abrupt("return",{data:{user:null,session:null},error:m});case 29:if(S=y.session,I=y.user,!y.session){e.next=36;break}return e.next=34,this._saveSession(y.session);case 34:return e.next=36,this._notifyAllSubscribers("SIGNED_IN",S);case 36:return e.abrupt("return",{data:{user:I,session:S},error:null});case 39:if(e.prev=39,e.t0=e.catch(0),!(0,p.f1)(e.t0)){e.next=43;break}return e.abrupt("return",{data:{user:null,session:null},error:e.t0});case 43:throw e.t0;case 44:case"end":return e.stop()}}),e,this,[[0,39]])})));return function(r){return e.apply(this,arguments)}}()},{key:"signInWithPassword",value:function(){var e=(0,o.Z)(c().mark((function e(r){var t,n,s,a,i,o,u,l,h,f;return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,!("email"in r)){e.next=8;break}return n=r.email,s=r.password,a=r.options,e.next=5,(0,d.cY)(this.fetch,"POST","".concat(this.url,"/token?grant_type=password"),{headers:this.headers,body:{email:n,password:s,gotrue_meta_security:{captcha_token:null===a||void 0===a?void 0:a.captchaToken}},xform:d.jv});case 5:case 12:t=e.sent,e.next=16;break;case 8:if(!("phone"in r)){e.next=15;break}return i=r.phone,o=r.password,u=r.options,e.next=12,(0,d.cY)(this.fetch,"POST","".concat(this.url,"/token?grant_type=password"),{headers:this.headers,body:{phone:i,password:o,gotrue_meta_security:{captcha_token:null===u||void 0===u?void 0:u.captchaToken}},xform:d.jv});case 15:throw new p.e_("You must provide either an email or phone number and a password");case 16:if(h=(l=t).data,!(f=l.error)){e.next=21;break}return e.abrupt("return",{data:{user:null,session:null},error:f});case 21:if(h&&h.session&&h.user){e.next=23;break}return e.abrupt("return",{data:{user:null,session:null},error:new p.eV});case 23:if(!h.session){e.next=28;break}return e.next=26,this._saveSession(h.session);case 26:return e.next=28,this._notifyAllSubscribers("SIGNED_IN",h.session);case 28:return e.abrupt("return",{data:Object.assign({user:h.user,session:h.session},h.weak_password?{weakPassword:h.weak_password}:null),error:f});case 31:if(e.prev=31,e.t0=e.catch(0),!(0,p.f1)(e.t0)){e.next=35;break}return e.abrupt("return",{data:{user:null,session:null},error:e.t0});case 35:throw e.t0;case 36:case"end":return e.stop()}}),e,this,[[0,31]])})));return function(r){return e.apply(this,arguments)}}()},{key:"signInWithOAuth",value:function(){var e=(0,o.Z)(c().mark((function e(r){var t,n,s,a;return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._handleProviderSignIn(r.provider,{redirectTo:null===(t=r.options)||void 0===t?void 0:t.redirectTo,scopes:null===(n=r.options)||void 0===n?void 0:n.scopes,queryParams:null===(s=r.options)||void 0===s?void 0:s.queryParams,skipBrowserRedirect:null===(a=r.options)||void 0===a?void 0:a.skipBrowserRedirect});case 2:return e.abrupt("return",e.sent);case 3:case"end":return e.stop()}}),e,this)})));return function(r){return e.apply(this,arguments)}}()},{key:"exchangeCodeForSession",value:function(){var e=(0,o.Z)(c().mark((function e(r){var t=this;return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.initializePromise;case 2:return e.abrupt("return",this._acquireLock(-1,(0,o.Z)(c().mark((function e(){return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",t._exchangeCodeForSession(r));case 1:case"end":return e.stop()}}),e)})))));case 3:case"end":return e.stop()}}),e,this)})));return function(r){return e.apply(this,arguments)}}()},{key:"signInWithWeb3",value:function(){var e=(0,o.Z)(c().mark((function e(r){var t;return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if("solana"!==(t=r.chain)){e.next=5;break}return e.next=4,this.signInWithSolana(r);case 4:return e.abrupt("return",e.sent);case 5:throw new Error('@supabase/auth-js: Unsupported chain "'.concat(t,'"'));case 6:case"end":return e.stop()}}),e,this)})));return function(r){return e.apply(this,arguments)}}()},{key:"signInWithSolana",value:function(){var e=(0,o.Z)(c().mark((function e(r){var t,s,a,i,o,u,l,h,v,b,k,x,_,g,y,m,S,I,T,Z,A,R,j,C,U,E;return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!("message"in r)){e.next=5;break}_=r.message,g=r.signature,e.next=53;break;case 5:if(r.chain,y=r.wallet,m=r.statement,S=r.options,(0,f.jU)()){e.next=12;break}if("object"===typeof y&&(null===S||void 0===S?void 0:S.url)){e.next=9;break}throw new Error("@supabase/auth-js: Both wallet and url must be specified in non-browser environments.");case 9:I=y,e.next=22;break;case 12:if("object"!==typeof y){e.next=16;break}I=y,e.next=22;break;case 16:if(!("solana"in(T=window))||"object"!==typeof T.solana||!("signIn"in T.solana&&"function"===typeof T.solana.signIn||"signMessage"in T.solana&&"function"===typeof T.solana.signMessage)){e.next=21;break}I=T.solana,e.next=22;break;case 21:throw new Error("@supabase/auth-js: No compatible Solana wallet interface on the window object (window.solana) detected. Make sure the user already has a wallet installed and connected for this app. Prefer passing the wallet interface object directly to signInWithWeb3({ chain: 'solana', wallet: resolvedUserWallet }) instead.");case 22:if(Z=new URL(null!==(t=null===S||void 0===S?void 0:S.url)&&void 0!==t?t:window.location.href),!("signIn"in I)||!I.signIn){e.next=44;break}return e.next=26,I.signIn(Object.assign(Object.assign(Object.assign({issuedAt:(new Date).toISOString()},null===S||void 0===S?void 0:S.signInWithSolana),{version:"1",domain:Z.host,uri:Z.href}),m?{statement:m}:null));case 26:if(A=e.sent,!Array.isArray(A)||!A[0]||"object"!==typeof A[0]){e.next=31;break}R=A[0],e.next=36;break;case 31:if(!(A&&"object"===typeof A&&"signedMessage"in A&&"signature"in A)){e.next=35;break}R=A,e.next=36;break;case 35:throw new Error("@supabase/auth-js: Wallet method signIn() returned unrecognized value");case 36:if(!("signedMessage"in R&&"signature"in R&&("string"===typeof R.signedMessage||R.signedMessage instanceof Uint8Array)&&R.signature instanceof Uint8Array)){e.next=41;break}_="string"===typeof R.signedMessage?R.signedMessage:(new TextDecoder).decode(R.signedMessage),g=R.signature,e.next=42;break;case 41:throw new Error("@supabase/auth-js: Wallet method signIn() API returned object without signedMessage and signature fields");case 42:e.next=53;break;case 44:if("signMessage"in I&&"function"===typeof I.signMessage&&"publicKey"in I&&"object"===typeof I&&I.publicKey&&"toBase58"in I.publicKey&&"function"===typeof I.publicKey.toBase58){e.next=46;break}throw new Error("@supabase/auth-js: Wallet does not have a compatible signMessage() and publicKey.toBase58() API");case 46:return _=["".concat(Z.host," wants you to sign in with your Solana account:"),I.publicKey.toBase58()].concat((0,n.Z)(m?["",m,""]:[""]),["Version: 1","URI: ".concat(Z.href),"Issued At: ".concat(null!==(a=null===(s=null===S||void 0===S?void 0:S.signInWithSolana)||void 0===s?void 0:s.issuedAt)&&void 0!==a?a:(new Date).toISOString())],(0,n.Z)((null===(i=null===S||void 0===S?void 0:S.signInWithSolana)||void 0===i?void 0:i.notBefore)?["Not Before: ".concat(S.signInWithSolana.notBefore)]:[]),(0,n.Z)((null===(o=null===S||void 0===S?void 0:S.signInWithSolana)||void 0===o?void 0:o.expirationTime)?["Expiration Time: ".concat(S.signInWithSolana.expirationTime)]:[]),(0,n.Z)((null===(u=null===S||void 0===S?void 0:S.signInWithSolana)||void 0===u?void 0:u.chainId)?["Chain ID: ".concat(S.signInWithSolana.chainId)]:[]),(0,n.Z)((null===(l=null===S||void 0===S?void 0:S.signInWithSolana)||void 0===l?void 0:l.nonce)?["Nonce: ".concat(S.signInWithSolana.nonce)]:[]),(0,n.Z)((null===(h=null===S||void 0===S?void 0:S.signInWithSolana)||void 0===h?void 0:h.requestId)?["Request ID: ".concat(S.signInWithSolana.requestId)]:[]),(0,n.Z)((null===(b=null===(v=null===S||void 0===S?void 0:S.signInWithSolana)||void 0===v?void 0:v.resources)||void 0===b?void 0:b.length)?["Resources"].concat((0,n.Z)(S.signInWithSolana.resources.map((function(e){return"- ".concat(e)})))):[])).join("\n"),e.next=49,I.signMessage((new TextEncoder).encode(_),"utf8");case 49:if((j=e.sent)&&j instanceof Uint8Array){e.next=52;break}throw new Error("@supabase/auth-js: Wallet signMessage() API returned an recognized value");case 52:g=j;case 53:return e.prev=53,e.next=56,(0,d.cY)(this.fetch,"POST","".concat(this.url,"/token?grant_type=web3"),{headers:this.headers,body:Object.assign({chain:"solana",message:_,signature:(0,w.rB)(g)},(null===(k=r.options)||void 0===k?void 0:k.captchaToken)?{gotrue_meta_security:{captcha_token:null===(x=r.options)||void 0===x?void 0:x.captchaToken}}:null),xform:d.vI});case 56:if(C=e.sent,U=C.data,!(E=C.error)){e.next=61;break}throw E;case 61:if(U&&U.session&&U.user){e.next=63;break}return e.abrupt("return",{data:{user:null,session:null},error:new p.eV});case 63:if(!U.session){e.next=68;break}return e.next=66,this._saveSession(U.session);case 66:return e.next=68,this._notifyAllSubscribers("SIGNED_IN",U.session);case 68:return e.abrupt("return",{data:Object.assign({},U),error:E});case 71:if(e.prev=71,e.t0=e.catch(53),!(0,p.f1)(e.t0)){e.next=75;break}return e.abrupt("return",{data:{user:null,session:null},error:e.t0});case 75:throw e.t0;case 76:case"end":return e.stop()}}),e,this,[[53,71]])})));return function(r){return e.apply(this,arguments)}}()},{key:"_exchangeCodeForSession",value:function(){var e=(0,o.Z)(c().mark((function e(r){var t,n,a,i,o,u,l,h;return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,(0,f.Dc)(this.storage,"".concat(this.storageKey,"-code-verifier"));case 2:return t=e.sent,n=(null!==t&&void 0!==t?t:"").split("/"),a=(0,s.Z)(n,2),i=a[0],o=a[1],e.prev=4,e.next=7,(0,d.cY)(this.fetch,"POST","".concat(this.url,"/token?grant_type=pkce"),{headers:this.headers,body:{auth_code:r,code_verifier:i},xform:d.vI});case 7:return u=e.sent,l=u.data,h=u.error,e.next=12,(0,f.Sv)(this.storage,"".concat(this.storageKey,"-code-verifier"));case 12:if(!h){e.next=14;break}throw h;case 14:if(l&&l.session&&l.user){e.next=16;break}return e.abrupt("return",{data:{user:null,session:null,redirectType:null},error:new p.eV});case 16:if(!l.session){e.next=21;break}return e.next=19,this._saveSession(l.session);case 19:return e.next=21,this._notifyAllSubscribers("SIGNED_IN",l.session);case 21:return e.abrupt("return",{data:Object.assign(Object.assign({},l),{redirectType:null!==o&&void 0!==o?o:null}),error:h});case 24:if(e.prev=24,e.t0=e.catch(4),!(0,p.f1)(e.t0)){e.next=28;break}return e.abrupt("return",{data:{user:null,session:null,redirectType:null},error:e.t0});case 28:throw e.t0;case 29:case"end":return e.stop()}}),e,this,[[4,24]])})));return function(r){return e.apply(this,arguments)}}()},{key:"signInWithIdToken",value:function(){var e=(0,o.Z)(c().mark((function e(r){var t,n,s,a,i,o,u,l;return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,t=r.options,n=r.provider,s=r.token,a=r.access_token,i=r.nonce,e.next=4,(0,d.cY)(this.fetch,"POST","".concat(this.url,"/token?grant_type=id_token"),{headers:this.headers,body:{provider:n,id_token:s,access_token:a,nonce:i,gotrue_meta_security:{captcha_token:null===t||void 0===t?void 0:t.captchaToken}},xform:d.vI});case 4:if(o=e.sent,u=o.data,!(l=o.error)){e.next=10;break}return e.abrupt("return",{data:{user:null,session:null},error:l});case 10:if(u&&u.session&&u.user){e.next=12;break}return e.abrupt("return",{data:{user:null,session:null},error:new p.eV});case 12:if(!u.session){e.next=17;break}return e.next=15,this._saveSession(u.session);case 15:return e.next=17,this._notifyAllSubscribers("SIGNED_IN",u.session);case 17:return e.abrupt("return",{data:u,error:l});case 20:if(e.prev=20,e.t0=e.catch(0),!(0,p.f1)(e.t0)){e.next=24;break}return e.abrupt("return",{data:{user:null,session:null},error:e.t0});case 24:throw e.t0;case 25:case"end":return e.stop()}}),e,this,[[0,20]])})));return function(r){return e.apply(this,arguments)}}()},{key:"signInWithOtp",value:function(){var e=(0,o.Z)(c().mark((function e(r){var t,n,a,i,o,u,l,h,v,b,k,x,w,_,g,y,m,S;return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,!("email"in r)){e.next=18;break}if(u=r.email,l=r.options,h=null,v=null,"pkce"!==this.flowType){e.next=13;break}return e.next=9,(0,f.__)(this.storage,this.storageKey);case 9:b=e.sent,k=(0,s.Z)(b,2),h=k[0],v=k[1];case 13:return e.next=15,(0,d.cY)(this.fetch,"POST","".concat(this.url,"/otp"),{headers:this.headers,body:{email:u,data:null!==(t=null===l||void 0===l?void 0:l.data)&&void 0!==t?t:{},create_user:null===(n=null===l||void 0===l?void 0:l.shouldCreateUser)||void 0===n||n,gotrue_meta_security:{captcha_token:null===l||void 0===l?void 0:l.captchaToken},code_challenge:h,code_challenge_method:v},redirectTo:null===l||void 0===l?void 0:l.emailRedirectTo});case 15:return x=e.sent,w=x.error,e.abrupt("return",{data:{user:null,session:null},error:w});case 18:if(!("phone"in r)){e.next=26;break}return _=r.phone,g=r.options,e.next=22,(0,d.cY)(this.fetch,"POST","".concat(this.url,"/otp"),{headers:this.headers,body:{phone:_,data:null!==(a=null===g||void 0===g?void 0:g.data)&&void 0!==a?a:{},create_user:null===(i=null===g||void 0===g?void 0:g.shouldCreateUser)||void 0===i||i,gotrue_meta_security:{captcha_token:null===g||void 0===g?void 0:g.captchaToken},channel:null!==(o=null===g||void 0===g?void 0:g.channel)&&void 0!==o?o:"sms"}});case 22:return y=e.sent,m=y.data,S=y.error,e.abrupt("return",{data:{user:null,session:null,messageId:null===m||void 0===m?void 0:m.message_id},error:S});case 26:throw new p.e_("You must provide either an email or phone number.");case 29:if(e.prev=29,e.t0=e.catch(0),!(0,p.f1)(e.t0)){e.next=33;break}return e.abrupt("return",{data:{user:null,session:null},error:e.t0});case 33:throw e.t0;case 34:case"end":return e.stop()}}),e,this,[[0,29]])})));return function(r){return e.apply(this,arguments)}}()},{key:"verifyOtp",value:function(){var e=(0,o.Z)(c().mark((function e(r){var t,n,s,a,i,o,u,l,h;return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,s=void 0,a=void 0,"options"in r&&(s=null===(t=r.options)||void 0===t?void 0:t.redirectTo,a=null===(n=r.options)||void 0===n?void 0:n.captchaToken),e.next=6,(0,d.cY)(this.fetch,"POST","".concat(this.url,"/verify"),{headers:this.headers,body:Object.assign(Object.assign({},r),{gotrue_meta_security:{captcha_token:a}}),redirectTo:s,xform:d.vI});case 6:if(i=e.sent,o=i.data,!(u=i.error)){e.next=11;break}throw u;case 11:if(o){e.next=13;break}throw new Error("An error occurred on token verification.");case 13:if(l=o.session,h=o.user,!(null===l||void 0===l?void 0:l.access_token)){e.next=20;break}return e.next=18,this._saveSession(l);case 18:return e.next=20,this._notifyAllSubscribers("recovery"==r.type?"PASSWORD_RECOVERY":"SIGNED_IN",l);case 20:return e.abrupt("return",{data:{user:h,session:l},error:null});case 23:if(e.prev=23,e.t0=e.catch(0),!(0,p.f1)(e.t0)){e.next=27;break}return e.abrupt("return",{data:{user:null,session:null},error:e.t0});case 27:throw e.t0;case 28:case"end":return e.stop()}}),e,this,[[0,23]])})));return function(r){return e.apply(this,arguments)}}()},{key:"signInWithSSO",value:function(){var e=(0,o.Z)(c().mark((function e(r){var t,n,a,i,o,u,l;return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,i=null,o=null,"pkce"!==this.flowType){e.next=11;break}return e.next=7,(0,f.__)(this.storage,this.storageKey);case 7:u=e.sent,l=(0,s.Z)(u,2),i=l[0],o=l[1];case 11:return e.next=13,(0,d.cY)(this.fetch,"POST","".concat(this.url,"/sso"),{body:Object.assign(Object.assign(Object.assign(Object.assign(Object.assign({},"providerId"in r?{provider_id:r.providerId}:null),"domain"in r?{domain:r.domain}:null),{redirect_to:null!==(n=null===(t=r.options)||void 0===t?void 0:t.redirectTo)&&void 0!==n?n:void 0}),(null===(a=null===r||void 0===r?void 0:r.options)||void 0===a?void 0:a.captchaToken)?{gotrue_meta_security:{captcha_token:r.options.captchaToken}}:null),{skip_http_redirect:!0,code_challenge:i,code_challenge_method:o}),headers:this.headers,xform:d.E_});case 13:return e.abrupt("return",e.sent);case 16:if(e.prev=16,e.t0=e.catch(0),!(0,p.f1)(e.t0)){e.next=20;break}return e.abrupt("return",{data:null,error:e.t0});case 20:throw e.t0;case 21:case"end":return e.stop()}}),e,this,[[0,16]])})));return function(r){return e.apply(this,arguments)}}()},{key:"reauthenticate",value:function(){var e=(0,o.Z)(c().mark((function e(){var r=this;return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.initializePromise;case 2:return e.next=4,this._acquireLock(-1,(0,o.Z)(c().mark((function e(){return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,r._reauthenticate();case 2:return e.abrupt("return",e.sent);case 3:case"end":return e.stop()}}),e)}))));case 4:return e.abrupt("return",e.sent);case 5:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"_reauthenticate",value:function(){var e=(0,o.Z)(c().mark((function e(){var r=this;return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,this._useSession(function(){var e=(0,o.Z)(c().mark((function e(t){var n,s,a,i;return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=t.data.session,!(s=t.error)){e.next=3;break}throw s;case 3:if(n){e.next=5;break}throw new p.GF;case 5:return e.next=7,(0,d.cY)(r.fetch,"GET","".concat(r.url,"/reauthenticate"),{headers:r.headers,jwt:n.access_token});case 7:return a=e.sent,i=a.error,e.abrupt("return",{data:{user:null,session:null},error:i});case 10:case"end":return e.stop()}}),e)})));return function(r){return e.apply(this,arguments)}}());case 3:return e.abrupt("return",e.sent);case 6:if(e.prev=6,e.t0=e.catch(0),!(0,p.f1)(e.t0)){e.next=10;break}return e.abrupt("return",{data:{user:null,session:null},error:e.t0});case 10:throw e.t0;case 11:case"end":return e.stop()}}),e,this,[[0,6]])})));return function(){return e.apply(this,arguments)}}()},{key:"resend",value:function(){var e=(0,o.Z)(c().mark((function e(r){var t,n,s,a,i,o,u,l,h,f,v,b;return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,t="".concat(this.url,"/resend"),!("email"in r)){e.next=11;break}return n=r.email,s=r.type,a=r.options,e.next=6,(0,d.cY)(this.fetch,"POST",t,{headers:this.headers,body:{email:n,type:s,gotrue_meta_security:{captcha_token:null===a||void 0===a?void 0:a.captchaToken}},redirectTo:null===a||void 0===a?void 0:a.emailRedirectTo});case 6:return i=e.sent,o=i.error,e.abrupt("return",{data:{user:null,session:null},error:o});case 11:if(!("phone"in r)){e.next=19;break}return u=r.phone,l=r.type,h=r.options,e.next=15,(0,d.cY)(this.fetch,"POST",t,{headers:this.headers,body:{phone:u,type:l,gotrue_meta_security:{captcha_token:null===h||void 0===h?void 0:h.captchaToken}}});case 15:return f=e.sent,v=f.data,b=f.error,e.abrupt("return",{data:{user:null,session:null,messageId:null===v||void 0===v?void 0:v.message_id},error:b});case 19:throw new p.e_("You must provide either an email or phone number and a type");case 22:if(e.prev=22,e.t0=e.catch(0),!(0,p.f1)(e.t0)){e.next=26;break}return e.abrupt("return",{data:{user:null,session:null},error:e.t0});case 26:throw e.t0;case 27:case"end":return e.stop()}}),e,this,[[0,22]])})));return function(r){return e.apply(this,arguments)}}()},{key:"getSession",value:function(){var e=(0,o.Z)(c().mark((function e(){var r,t=this;return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.initializePromise;case 2:return e.next=4,this._acquireLock(-1,(0,o.Z)(c().mark((function e(){return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",t._useSession(function(){var e=(0,o.Z)(c().mark((function e(r){return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",r);case 1:case"end":return e.stop()}}),e)})));return function(r){return e.apply(this,arguments)}}()));case 1:case"end":return e.stop()}}),e)}))));case 4:return r=e.sent,e.abrupt("return",r);case 6:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"_acquireLock",value:function(){var e=(0,o.Z)(c().mark((function e(r,t){var s,a,i=this;return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this._debug("#_acquireLock","begin",r),e.prev=1,!this.lockAcquired){e.next=7;break}return s=this.pendingInLock.length?this.pendingInLock[this.pendingInLock.length-1]:Promise.resolve(),a=(0,o.Z)(c().mark((function e(){return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,s;case 2:return e.next=4,t();case 4:return e.abrupt("return",e.sent);case 5:case"end":return e.stop()}}),e)})))(),this.pendingInLock.push((0,o.Z)(c().mark((function e(){return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,a;case 3:e.next=7;break;case 5:e.prev=5,e.t0=e.catch(0);case 7:case"end":return e.stop()}}),e,null,[[0,5]])})))()),e.abrupt("return",a);case 7:return e.next=9,this.lock("lock:".concat(this.storageKey),r,(0,o.Z)(c().mark((function e(){var r,s;return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return i._debug("#_acquireLock","lock acquired for storage key",i.storageKey),e.prev=1,i.lockAcquired=!0,r=t(),i.pendingInLock.push((0,o.Z)(c().mark((function e(){return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,r;case 3:e.next=7;break;case 5:e.prev=5,e.t0=e.catch(0);case 7:case"end":return e.stop()}}),e,null,[[0,5]])})))()),e.next=7,r;case 7:if(!i.pendingInLock.length){e.next=14;break}return s=(0,n.Z)(i.pendingInLock),e.next=11,Promise.all(s);case 11:i.pendingInLock.splice(0,s.length),e.next=7;break;case 14:return e.next=16,r;case 16:return e.abrupt("return",e.sent);case 17:return e.prev=17,i._debug("#_acquireLock","lock released for storage key",i.storageKey),i.lockAcquired=!1,e.finish(17);case 21:case"end":return e.stop()}}),e,null,[[1,,17,21]])}))));case 9:return e.abrupt("return",e.sent);case 10:return e.prev=10,this._debug("#_acquireLock","end"),e.finish(10);case 13:case"end":return e.stop()}}),e,this,[[1,,10,13]])})));return function(r,t){return e.apply(this,arguments)}}()},{key:"_useSession",value:function(){var e=(0,o.Z)(c().mark((function e(r){var t;return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this._debug("#_useSession","begin"),e.prev=1,e.next=4,this.__loadSession();case 4:return t=e.sent,e.next=7,r(t);case 7:return e.abrupt("return",e.sent);case 8:return e.prev=8,this._debug("#_useSession","end"),e.finish(8);case 11:case"end":return e.stop()}}),e,this,[[1,,8,11]])})));return function(r){return e.apply(this,arguments)}}()},{key:"__loadSession",value:function(){var e=(0,o.Z)(c().mark((function e(){var r,t,n,s,a,i,o,u,l=this;return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this._debug("#__loadSession()","begin"),this.lockAcquired||this._debug("#__loadSession()","used outside of an acquired lock!",(new Error).stack),e.prev=2,r=null,e.next=6,(0,f.Dc)(this.storage,this.storageKey);case 6:if(t=e.sent,this._debug("#getSession()","session from storage",t),null===t){e.next=16;break}if(!this._isValidSession(t)){e.next=13;break}r=t,e.next=16;break;case 13:return this._debug("#getSession()","session from storage is not valid"),e.next=16,this._removeSession();case 16:if(r){e.next=18;break}return e.abrupt("return",{data:{session:null},error:null});case 18:if(n=!!r.expires_at&&1e3*r.expires_at-Date.now()<h.Uj,this._debug("#__loadSession()","session has".concat(n?"":" not"," expired"),"expires_at",r.expires_at),n){e.next=23;break}return this.storage.isServer&&(s=this.suppressGetSessionWarning,a=new Proxy(r,{get:function(e,r,t){return s||"user"!==r||(console.warn("Using the user object as returned from supabase.auth.getSession() or from some supabase.auth.onAuthStateChange() events could be insecure! This value comes directly from the storage medium (usually cookies on the server) and may not be authentic. Use supabase.auth.getUser() instead which authenticates the data by contacting the Supabase Auth server."),s=!0,l.suppressGetSessionWarning=!0),Reflect.get(e,r,t)}}),r=a),e.abrupt("return",{data:{session:r},error:null});case 23:return e.next=25,this._callRefreshToken(r.refresh_token);case 25:if(i=e.sent,o=i.session,!(u=i.error)){e.next=30;break}return e.abrupt("return",{data:{session:null},error:u});case 30:return e.abrupt("return",{data:{session:o},error:null});case 31:return e.prev=31,this._debug("#__loadSession()","end"),e.finish(31);case 34:case"end":return e.stop()}}),e,this,[[2,,31,34]])})));return function(){return e.apply(this,arguments)}}()},{key:"getUser",value:function(){var e=(0,o.Z)(c().mark((function e(r){var t,n=this;return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!r){e.next=4;break}return e.next=3,this._getUser(r);case 3:return e.abrupt("return",e.sent);case 4:return e.next=6,this.initializePromise;case 6:return e.next=8,this._acquireLock(-1,(0,o.Z)(c().mark((function e(){return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,n._getUser();case 2:return e.abrupt("return",e.sent);case 3:case"end":return e.stop()}}),e)}))));case 8:return t=e.sent,e.abrupt("return",t);case 10:case"end":return e.stop()}}),e,this)})));return function(r){return e.apply(this,arguments)}}()},{key:"_getUser",value:function(){var e=(0,o.Z)(c().mark((function e(r){var t=this;return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,!r){e.next=5;break}return e.next=4,(0,d.cY)(this.fetch,"GET","".concat(this.url,"/user"),{headers:this.headers,jwt:r,xform:d.Br});case 4:case 7:return e.abrupt("return",e.sent);case 5:return e.next=7,this._useSession(function(){var e=(0,o.Z)(c().mark((function e(r){var n,s,a,i,o;return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(i=r.data,!(o=r.error)){e.next=3;break}throw o;case 3:if((null===(n=i.session)||void 0===n?void 0:n.access_token)||t.hasCustomAuthorizationHeader){e.next=5;break}return e.abrupt("return",{data:{user:null},error:new p.GF});case 5:return e.next=7,(0,d.cY)(t.fetch,"GET","".concat(t.url,"/user"),{headers:t.headers,jwt:null!==(a=null===(s=i.session)||void 0===s?void 0:s.access_token)&&void 0!==a?a:void 0,xform:d.Br});case 7:return e.abrupt("return",e.sent);case 8:case"end":return e.stop()}}),e)})));return function(r){return e.apply(this,arguments)}}());case 10:if(e.prev=10,e.t0=e.catch(0),!(0,p.f1)(e.t0)){e.next=19;break}if(!(0,p.t)(e.t0)){e.next=18;break}return e.next=16,this._removeSession();case 16:return e.next=18,(0,f.Sv)(this.storage,"".concat(this.storageKey,"-code-verifier"));case 18:return e.abrupt("return",{data:{user:null},error:e.t0});case 19:throw e.t0;case 20:case"end":return e.stop()}}),e,this,[[0,10]])})));return function(r){return e.apply(this,arguments)}}()},{key:"updateUser",value:function(){var e=(0,o.Z)(c().mark((function e(r){var t,n=this,s=arguments;return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=s.length>1&&void 0!==s[1]?s[1]:{},e.next=3,this.initializePromise;case 3:return e.next=5,this._acquireLock(-1,(0,o.Z)(c().mark((function e(){return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,n._updateUser(r,t);case 2:return e.abrupt("return",e.sent);case 3:case"end":return e.stop()}}),e)}))));case 5:return e.abrupt("return",e.sent);case 6:case"end":return e.stop()}}),e,this)})));return function(r){return e.apply(this,arguments)}}()},{key:"_updateUser",value:function(){var e=(0,o.Z)(c().mark((function e(r){var t,n=this,a=arguments;return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=a.length>1&&void 0!==a[1]?a[1]:{},e.prev=1,e.next=4,this._useSession(function(){var e=(0,o.Z)(c().mark((function e(a){var i,o,u,l,h,v,b,k,x,w;return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(i=a.data,!(o=a.error)){e.next=3;break}throw o;case 3:if(i.session){e.next=5;break}throw new p.GF;case 5:if(u=i.session,l=null,h=null,"pkce"!==n.flowType||null==r.email){e.next=16;break}return e.next=12,(0,f.__)(n.storage,n.storageKey);case 12:v=e.sent,b=(0,s.Z)(v,2),l=b[0],h=b[1];case 16:return e.next=18,(0,d.cY)(n.fetch,"PUT","".concat(n.url,"/user"),{headers:n.headers,redirectTo:null===t||void 0===t?void 0:t.emailRedirectTo,body:Object.assign(Object.assign({},r),{code_challenge:l,code_challenge_method:h}),jwt:u.access_token,xform:d.Br});case 18:if(k=e.sent,x=k.data,!(w=k.error)){e.next=23;break}throw w;case 23:return u.user=x.user,e.next=26,n._saveSession(u);case 26:return e.next=28,n._notifyAllSubscribers("USER_UPDATED",u);case 28:return e.abrupt("return",{data:{user:u.user},error:null});case 29:case"end":return e.stop()}}),e)})));return function(r){return e.apply(this,arguments)}}());case 4:return e.abrupt("return",e.sent);case 7:if(e.prev=7,e.t0=e.catch(1),!(0,p.f1)(e.t0)){e.next=11;break}return e.abrupt("return",{data:{user:null},error:e.t0});case 11:throw e.t0;case 12:case"end":return e.stop()}}),e,this,[[1,7]])})));return function(r){return e.apply(this,arguments)}}()},{key:"setSession",value:function(){var e=(0,o.Z)(c().mark((function e(r){var t=this;return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.initializePromise;case 2:return e.next=4,this._acquireLock(-1,(0,o.Z)(c().mark((function e(){return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,t._setSession(r);case 2:return e.abrupt("return",e.sent);case 3:case"end":return e.stop()}}),e)}))));case 4:return e.abrupt("return",e.sent);case 5:case"end":return e.stop()}}),e,this)})));return function(r){return e.apply(this,arguments)}}()},{key:"_setSession",value:function(){var e=(0,o.Z)(c().mark((function e(r){var t,n,s,a,i,o,u,l,h,d,v,b;return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,r.access_token&&r.refresh_token){e.next=3;break}throw new p.GF;case 3:if(t=Date.now()/1e3,n=t,s=!0,a=null,i=(0,f.xp)(r.access_token),(o=i.payload).exp&&(n=o.exp,s=n<=t),!s){e.next=22;break}return e.next=12,this._callRefreshToken(r.refresh_token);case 12:if(u=e.sent,l=u.session,!(h=u.error)){e.next=17;break}return e.abrupt("return",{data:{user:null,session:null},error:h});case 17:if(l){e.next=19;break}return e.abrupt("return",{data:{user:null,session:null},error:null});case 19:a=l,e.next=34;break;case 22:return e.next=24,this._getUser(r.access_token);case 24:if(d=e.sent,v=d.data,!(b=d.error)){e.next=29;break}throw b;case 29:return a={access_token:r.access_token,refresh_token:r.refresh_token,user:v.user,token_type:"bearer",expires_in:n-t,expires_at:n},e.next=32,this._saveSession(a);case 32:return e.next=34,this._notifyAllSubscribers("SIGNED_IN",a);case 34:return e.abrupt("return",{data:{user:a.user,session:a},error:null});case 37:if(e.prev=37,e.t0=e.catch(0),!(0,p.f1)(e.t0)){e.next=41;break}return e.abrupt("return",{data:{session:null,user:null},error:e.t0});case 41:throw e.t0;case 42:case"end":return e.stop()}}),e,this,[[0,37]])})));return function(r){return e.apply(this,arguments)}}()},{key:"refreshSession",value:function(){var e=(0,o.Z)(c().mark((function e(r){var t=this;return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.initializePromise;case 2:return e.next=4,this._acquireLock(-1,(0,o.Z)(c().mark((function e(){return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,t._refreshSession(r);case 2:return e.abrupt("return",e.sent);case 3:case"end":return e.stop()}}),e)}))));case 4:return e.abrupt("return",e.sent);case 5:case"end":return e.stop()}}),e,this)})));return function(r){return e.apply(this,arguments)}}()},{key:"_refreshSession",value:function(){var e=(0,o.Z)(c().mark((function e(r){var t=this;return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,this._useSession(function(){var e=(0,o.Z)(c().mark((function e(n){var s,a,i,o,u,l;return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r){e.next=5;break}if(a=n.data,!(i=n.error)){e.next=4;break}throw i;case 4:r=null!==(s=a.session)&&void 0!==s?s:void 0;case 5:if(null===r||void 0===r?void 0:r.refresh_token){e.next=7;break}throw new p.GF;case 7:return e.next=9,t._callRefreshToken(r.refresh_token);case 9:if(o=e.sent,u=o.session,!(l=o.error)){e.next=14;break}return e.abrupt("return",{data:{user:null,session:null},error:l});case 14:if(u){e.next=16;break}return e.abrupt("return",{data:{user:null,session:null},error:null});case 16:return e.abrupt("return",{data:{user:u.user,session:u},error:null});case 17:case"end":return e.stop()}}),e)})));return function(r){return e.apply(this,arguments)}}());case 3:return e.abrupt("return",e.sent);case 6:if(e.prev=6,e.t0=e.catch(0),!(0,p.f1)(e.t0)){e.next=10;break}return e.abrupt("return",{data:{user:null,session:null},error:e.t0});case 10:throw e.t0;case 11:case"end":return e.stop()}}),e,this,[[0,6]])})));return function(r){return e.apply(this,arguments)}}()},{key:"_getSessionFromURL",value:function(){var e=(0,o.Z)(c().mark((function e(r,t){var n,s,a,i,o,u,l,d,v,b,k,x,w,_,g,y,m,S,I,T;return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,(0,f.jU)()){e.next=3;break}throw new p.LI("No browser detected.");case 3:if(!(r.error||r.error_description||r.error_code)){e.next=5;break}throw new p.LI(r.error_description||"Error in URL with unspecified error_description",{error:r.error||"unspecified_error",code:r.error_code||"unspecified_code"});case 5:e.t0=t,e.next="implicit"===e.t0?8:"pkce"===e.t0?11:14;break;case 8:if("pkce"!==this.flowType){e.next=10;break}throw new p.Po("Not a valid PKCE flow url.");case 10:case 13:return e.abrupt("break",14);case 11:if("implicit"!==this.flowType){e.next=13;break}throw new p.LI("Not a valid implicit grant flow url.");case 14:if("pkce"!==t){e.next=29;break}if(this._debug("#_initialize()","begin","is PKCE flow",!0),r.code){e.next=18;break}throw new p.Po("No code detected.");case 18:return e.next=20,this._exchangeCodeForSession(r.code);case 20:if(n=e.sent,s=n.data,!(a=n.error)){e.next=25;break}throw a;case 25:return(i=new URL(window.location.href)).searchParams.delete("code"),window.history.replaceState(window.history.state,"",i.toString()),e.abrupt("return",{data:{session:s.session,redirectType:null},error:null});case 29:if(o=r.provider_token,u=r.provider_refresh_token,l=r.access_token,d=r.refresh_token,v=r.expires_in,b=r.expires_at,k=r.token_type,l&&v&&d&&k){e.next=32;break}throw new p.LI("No session defined in URL");case 32:return x=Math.round(Date.now()/1e3),w=parseInt(v),_=x+w,b&&(_=parseInt(b)),1e3*(g=_-x)<=h.r6&&console.warn("@supabase/gotrue-js: Session as retrieved from URL expires in ".concat(g,"s, should have been closer to ").concat(w,"s")),x-(y=_-w)>=120?console.warn("@supabase/gotrue-js: Session as retrieved from URL was issued over 120s ago, URL could be stale",y,_,x):x-y<0&&console.warn("@supabase/gotrue-js: Session as retrieved from URL was issued in the future? Check the device clock for skew",y,_,x),e.next=42,this._getUser(l);case 42:if(m=e.sent,S=m.data,!(I=m.error)){e.next=47;break}throw I;case 47:return T={provider_token:o,provider_refresh_token:u,access_token:l,expires_in:w,expires_at:_,refresh_token:d,token_type:k,user:S.user},window.location.hash="",this._debug("#_getSessionFromURL()","clearing window.location.hash"),e.abrupt("return",{data:{session:T,redirectType:r.type},error:null});case 53:if(e.prev=53,e.t1=e.catch(0),!(0,p.f1)(e.t1)){e.next=57;break}return e.abrupt("return",{data:{session:null,redirectType:null},error:e.t1});case 57:throw e.t1;case 58:case"end":return e.stop()}}),e,this,[[0,53]])})));return function(r,t){return e.apply(this,arguments)}}()},{key:"_isImplicitGrantCallback",value:function(e){return Boolean(e.access_token||e.error_description)}},{key:"_isPKCECallback",value:function(){var e=(0,o.Z)(c().mark((function e(r){var t;return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,(0,f.Dc)(this.storage,"".concat(this.storageKey,"-code-verifier"));case 2:return t=e.sent,e.abrupt("return",!(!r.code||!t));case 4:case"end":return e.stop()}}),e,this)})));return function(r){return e.apply(this,arguments)}}()},{key:"signOut",value:function(){var e=(0,o.Z)(c().mark((function e(){var r,t=this,n=arguments;return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=n.length>0&&void 0!==n[0]?n[0]:{scope:"global"},e.next=3,this.initializePromise;case 3:return e.next=5,this._acquireLock(-1,(0,o.Z)(c().mark((function e(){return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,t._signOut(r);case 2:return e.abrupt("return",e.sent);case 3:case"end":return e.stop()}}),e)}))));case 5:return e.abrupt("return",e.sent);case 6:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"_signOut",value:function(){var e=(0,o.Z)(c().mark((function e(){var r,t=this,n=arguments;return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=(n.length>0&&void 0!==n[0]?n[0]:{scope:"global"}).scope,e.next=3,this._useSession(function(){var e=(0,o.Z)(c().mark((function e(n){var s,a,i,o,u,l;return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(a=n.data,!(i=n.error)){e.next=3;break}return e.abrupt("return",{error:i});case 3:if(!(o=null===(s=a.session)||void 0===s?void 0:s.access_token)){e.next=12;break}return e.next=7,t.admin.signOut(o,r);case 7:if(u=e.sent,!(l=u.error)){e.next=12;break}if((0,p.Tw)(l)&&(404===l.status||401===l.status||403===l.status)){e.next=12;break}return e.abrupt("return",{error:l});case 12:if("others"===r){e.next=17;break}return e.next=15,t._removeSession();case 15:return e.next=17,(0,f.Sv)(t.storage,"".concat(t.storageKey,"-code-verifier"));case 17:return e.abrupt("return",{error:null});case 18:case"end":return e.stop()}}),e)})));return function(r){return e.apply(this,arguments)}}());case 3:return e.abrupt("return",e.sent);case 4:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"onAuthStateChange",value:function(e){var r=this,t=(0,f.Vj)(),n={id:t,callback:e,unsubscribe:function(){r._debug("#unsubscribe()","state change callback with id removed",t),r.stateChangeEmitters.delete(t)}};return this._debug("#onAuthStateChange()","registered callback with id",t),this.stateChangeEmitters.set(t,n),(0,o.Z)(c().mark((function e(){return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,r.initializePromise;case 2:return e.next=4,r._acquireLock(-1,(0,o.Z)(c().mark((function e(){return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:r._emitInitialSession(t);case 1:case"end":return e.stop()}}),e)}))));case 4:case"end":return e.stop()}}),e)})))(),{data:{subscription:n}}}},{key:"_emitInitialSession",value:function(){var e=(0,o.Z)(c().mark((function e(r){var t=this;return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._useSession(function(){var e=(0,o.Z)(c().mark((function e(n){var s,a,i,o;return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,i=n.data.session,!(o=n.error)){e.next=4;break}throw o;case 4:return e.next=6,null===(s=t.stateChangeEmitters.get(r))||void 0===s?void 0:s.callback("INITIAL_SESSION",i);case 6:t._debug("INITIAL_SESSION","callback id",r,"session",i),e.next=15;break;case 9:return e.prev=9,e.t0=e.catch(0),e.next=13,null===(a=t.stateChangeEmitters.get(r))||void 0===a?void 0:a.callback("INITIAL_SESSION",null);case 13:t._debug("INITIAL_SESSION","callback id",r,"error",e.t0),console.error(e.t0);case 15:case"end":return e.stop()}}),e,null,[[0,9]])})));return function(r){return e.apply(this,arguments)}}());case 2:return e.abrupt("return",e.sent);case 3:case"end":return e.stop()}}),e,this)})));return function(r){return e.apply(this,arguments)}}()},{key:"resetPasswordForEmail",value:function(){var e=(0,o.Z)(c().mark((function e(r){var t,n,a,i,o,u=arguments;return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t=u.length>1&&void 0!==u[1]?u[1]:{},n=null,a=null,"pkce"!==this.flowType){e.next=11;break}return e.next=7,(0,f.__)(this.storage,this.storageKey,!0);case 7:i=e.sent,o=(0,s.Z)(i,2),n=o[0],a=o[1];case 11:return e.prev=11,e.next=14,(0,d.cY)(this.fetch,"POST","".concat(this.url,"/recover"),{body:{email:r,code_challenge:n,code_challenge_method:a,gotrue_meta_security:{captcha_token:t.captchaToken}},headers:this.headers,redirectTo:t.redirectTo});case 14:return e.abrupt("return",e.sent);case 17:if(e.prev=17,e.t0=e.catch(11),!(0,p.f1)(e.t0)){e.next=21;break}return e.abrupt("return",{data:null,error:e.t0});case 21:throw e.t0;case 22:case"end":return e.stop()}}),e,this,[[11,17]])})));return function(r){return e.apply(this,arguments)}}()},{key:"getUserIdentities",value:function(){var e=(0,o.Z)(c().mark((function e(){var r,t,n,s;return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,this.getUser();case 3:if(t=e.sent,n=t.data,!(s=t.error)){e.next=8;break}throw s;case 8:return e.abrupt("return",{data:{identities:null!==(r=n.user.identities)&&void 0!==r?r:[]},error:null});case 11:if(e.prev=11,e.t0=e.catch(0),!(0,p.f1)(e.t0)){e.next=15;break}return e.abrupt("return",{data:null,error:e.t0});case 15:throw e.t0;case 16:case"end":return e.stop()}}),e,this,[[0,11]])})));return function(){return e.apply(this,arguments)}}()},{key:"linkIdentity",value:function(){var e=(0,o.Z)(c().mark((function e(r){var t,n,s,a,i=this;return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,this._useSession(function(){var e=(0,o.Z)(c().mark((function e(t){var n,s,a,o,u,l,h,p;return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(l=t.data,!(h=t.error)){e.next=3;break}throw h;case 3:return e.next=5,i._getUrlForProvider("".concat(i.url,"/user/identities/authorize"),r.provider,{redirectTo:null===(n=r.options)||void 0===n?void 0:n.redirectTo,scopes:null===(s=r.options)||void 0===s?void 0:s.scopes,queryParams:null===(a=r.options)||void 0===a?void 0:a.queryParams,skipBrowserRedirect:!0});case 5:return p=e.sent,e.next=8,(0,d.cY)(i.fetch,"GET",p,{headers:i.headers,jwt:null!==(u=null===(o=l.session)||void 0===o?void 0:o.access_token)&&void 0!==u?u:void 0});case 8:return e.abrupt("return",e.sent);case 9:case"end":return e.stop()}}),e)})));return function(r){return e.apply(this,arguments)}}());case 3:if(n=e.sent,s=n.data,!(a=n.error)){e.next=8;break}throw a;case 8:return(0,f.jU)()&&!(null===(t=r.options)||void 0===t?void 0:t.skipBrowserRedirect)&&window.location.assign(null===s||void 0===s?void 0:s.url),e.abrupt("return",{data:{provider:r.provider,url:null===s||void 0===s?void 0:s.url},error:null});case 12:if(e.prev=12,e.t0=e.catch(0),!(0,p.f1)(e.t0)){e.next=16;break}return e.abrupt("return",{data:{provider:r.provider,url:null},error:e.t0});case 16:throw e.t0;case 17:case"end":return e.stop()}}),e,this,[[0,12]])})));return function(r){return e.apply(this,arguments)}}()},{key:"unlinkIdentity",value:function(){var e=(0,o.Z)(c().mark((function e(r){var t=this;return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,this._useSession(function(){var e=(0,o.Z)(c().mark((function e(n){var s,a,i,o;return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(i=n.data,!(o=n.error)){e.next=3;break}throw o;case 3:return e.next=5,(0,d.cY)(t.fetch,"DELETE","".concat(t.url,"/user/identities/").concat(r.identity_id),{headers:t.headers,jwt:null!==(a=null===(s=i.session)||void 0===s?void 0:s.access_token)&&void 0!==a?a:void 0});case 5:return e.abrupt("return",e.sent);case 6:case"end":return e.stop()}}),e)})));return function(r){return e.apply(this,arguments)}}());case 3:return e.abrupt("return",e.sent);case 6:if(e.prev=6,e.t0=e.catch(0),!(0,p.f1)(e.t0)){e.next=10;break}return e.abrupt("return",{data:null,error:e.t0});case 10:throw e.t0;case 11:case"end":return e.stop()}}),e,this,[[0,6]])})));return function(r){return e.apply(this,arguments)}}()},{key:"_refreshAccessToken",value:function(){var e=(0,o.Z)(c().mark((function e(r){var t,n,s=this;return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t="#_refreshAccessToken(".concat(r.substring(0,5),"...)"),this._debug(t,"begin"),e.prev=2,n=Date.now(),e.next=6,(0,f.Rd)(function(){var e=(0,o.Z)(c().mark((function e(n){return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!(n>0)){e.next=3;break}return e.next=3,(0,f._v)(200*Math.pow(2,n-1));case 3:return s._debug(t,"refreshing attempt",n),e.next=6,(0,d.cY)(s.fetch,"POST","".concat(s.url,"/token?grant_type=refresh_token"),{body:{refresh_token:r},headers:s.headers,xform:d.vI});case 6:return e.abrupt("return",e.sent);case 7:case"end":return e.stop()}}),e)})));return function(r){return e.apply(this,arguments)}}(),(function(e,r){var t=200*Math.pow(2,e);return r&&(0,p.AO)(r)&&Date.now()+t-n<h.r6}));case 6:return e.abrupt("return",e.sent);case 9:if(e.prev=9,e.t0=e.catch(2),this._debug(t,"error",e.t0),!(0,p.f1)(e.t0)){e.next=14;break}return e.abrupt("return",{data:{session:null,user:null},error:e.t0});case 14:throw e.t0;case 15:return e.prev=15,this._debug(t,"end"),e.finish(15);case 18:case"end":return e.stop()}}),e,this,[[2,9,15,18]])})));return function(r){return e.apply(this,arguments)}}()},{key:"_isValidSession",value:function(e){return"object"===typeof e&&null!==e&&"access_token"in e&&"refresh_token"in e&&"expires_at"in e}},{key:"_handleProviderSignIn",value:function(){var e=(0,o.Z)(c().mark((function e(r,t){var n;return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._getUrlForProvider("".concat(this.url,"/authorize"),r,{redirectTo:t.redirectTo,scopes:t.scopes,queryParams:t.queryParams});case 2:return n=e.sent,this._debug("#_handleProviderSignIn()","provider",r,"options",t,"url",n),(0,f.jU)()&&!t.skipBrowserRedirect&&window.location.assign(n),e.abrupt("return",{data:{provider:r,url:n},error:null});case 6:case"end":return e.stop()}}),e,this)})));return function(r,t){return e.apply(this,arguments)}}()},{key:"_recoverAndRefresh",value:function(){var e=(0,o.Z)(c().mark((function e(){var r,t,n,s,a,i;return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t="#_recoverAndRefresh()",this._debug(t,"begin"),e.prev=2,e.next=5,(0,f.Dc)(this.storage,this.storageKey);case 5:if(n=e.sent,this._debug(t,"session from storage",n),this._isValidSession(n)){e.next=13;break}if(this._debug(t,"session is not valid"),null===n){e.next=12;break}return e.next=12,this._removeSession();case 12:return e.abrupt("return");case 13:if(s=1e3*(null!==(r=n.expires_at)&&void 0!==r?r:1/0)-Date.now()<h.Uj,this._debug(t,"session has".concat(s?"":" not"," expired with margin of ").concat(h.Uj,"s")),!s){e.next=29;break}if(!this.autoRefreshToken||!n.refresh_token){e.next=27;break}return e.next=19,this._callRefreshToken(n.refresh_token);case 19:if(a=e.sent,!(i=a.error)){e.next=27;break}if(console.error(i),(0,p.AO)(i)){e.next=27;break}return this._debug(t,"refresh failed with a non-retryable error, removing the session",i),e.next=27,this._removeSession();case 27:e.next=31;break;case 29:return e.next=31,this._notifyAllSubscribers("SIGNED_IN",n);case 31:e.next=38;break;case 33:return e.prev=33,e.t0=e.catch(2),this._debug(t,"error",e.t0),console.error(e.t0),e.abrupt("return");case 38:return e.prev=38,this._debug(t,"end"),e.finish(38);case 41:case"end":return e.stop()}}),e,this,[[2,33,38,41]])})));return function(){return e.apply(this,arguments)}}()},{key:"_callRefreshToken",value:function(){var e=(0,o.Z)(c().mark((function e(r){var t,n,s,a,i,o,u,l;return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r){e.next=2;break}throw new p.GF;case 2:if(!this.refreshingDeferred){e.next=4;break}return e.abrupt("return",this.refreshingDeferred.promise);case 4:return s="#_callRefreshToken(".concat(r.substring(0,5),"...)"),this._debug(s,"begin"),e.prev=6,this.refreshingDeferred=new f.BH,e.next=10,this._refreshAccessToken(r);case 10:if(a=e.sent,i=a.data,!(o=a.error)){e.next=15;break}throw o;case 15:if(i.session){e.next=17;break}throw new p.GF;case 17:return e.next=19,this._saveSession(i.session);case 19:return e.next=21,this._notifyAllSubscribers("TOKEN_REFRESHED",i.session);case 21:return u={session:i.session,error:null},this.refreshingDeferred.resolve(u),e.abrupt("return",u);case 26:if(e.prev=26,e.t0=e.catch(6),this._debug(s,"error",e.t0),!(0,p.f1)(e.t0)){e.next=36;break}if(l={session:null,error:e.t0},(0,p.AO)(e.t0)){e.next=34;break}return e.next=34,this._removeSession();case 34:return null===(t=this.refreshingDeferred)||void 0===t||t.resolve(l),e.abrupt("return",l);case 36:throw null===(n=this.refreshingDeferred)||void 0===n||n.reject(e.t0),e.t0;case 38:return e.prev=38,this.refreshingDeferred=null,this._debug(s,"end"),e.finish(38);case 42:case"end":return e.stop()}}),e,this,[[6,26,38,42]])})));return function(r){return e.apply(this,arguments)}}()},{key:"_notifyAllSubscribers",value:function(){var e=(0,o.Z)(c().mark((function e(r,t){var n,s,a,i,u,l=arguments;return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=!(l.length>2&&void 0!==l[2])||l[2],s="#_notifyAllSubscribers(".concat(r,")"),this._debug(s,"begin",t,"broadcast = ".concat(n)),e.prev=3,this.broadcastChannel&&n&&this.broadcastChannel.postMessage({event:r,session:t}),a=[],i=Array.from(this.stateChangeEmitters.values()).map(function(){var e=(0,o.Z)(c().mark((function e(n){return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,n.callback(r,t);case 3:e.next=8;break;case 5:e.prev=5,e.t0=e.catch(0),a.push(e.t0);case 8:case"end":return e.stop()}}),e,null,[[0,5]])})));return function(r){return e.apply(this,arguments)}}()),e.next=9,Promise.all(i);case 9:if(!(a.length>0)){e.next=12;break}for(u=0;u<a.length;u+=1)console.error(a[u]);throw a[0];case 12:return e.prev=12,this._debug(s,"end"),e.finish(12);case 15:case"end":return e.stop()}}),e,this,[[3,,12,15]])})));return function(r,t){return e.apply(this,arguments)}}()},{key:"_saveSession",value:function(){var e=(0,o.Z)(c().mark((function e(r){return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this._debug("#_saveSession()",r),this.suppressGetSessionWarning=!0,e.next=4,(0,f.eg)(this.storage,this.storageKey,r);case 4:case"end":return e.stop()}}),e,this)})));return function(r){return e.apply(this,arguments)}}()},{key:"_removeSession",value:function(){var e=(0,o.Z)(c().mark((function e(){return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this._debug("#_removeSession()"),e.next=3,(0,f.Sv)(this.storage,this.storageKey);case 3:return e.next=5,this._notifyAllSubscribers("SIGNED_OUT",null);case 5:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"_removeVisibilityChangedCallback",value:function(){this._debug("#_removeVisibilityChangedCallback()");var e=this.visibilityChangedCallback;this.visibilityChangedCallback=null;try{e&&(0,f.jU)()&&(null===window||void 0===window?void 0:window.removeEventListener)&&window.removeEventListener("visibilitychange",e)}catch(r){console.error("removing visibilitychange callback failed",r)}}},{key:"_startAutoRefresh",value:function(){var e=(0,o.Z)(c().mark((function e(){var r,t=this;return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._stopAutoRefresh();case 2:this._debug("#_startAutoRefresh()"),r=setInterval((function(){return t._autoRefreshTokenTick()}),h.r6),this.autoRefreshTicker=r,r&&"object"===typeof r&&"function"===typeof r.unref?r.unref():"undefined"!==typeof Deno&&"function"===typeof Deno.unrefTimer&&Deno.unrefTimer(r),setTimeout((0,o.Z)(c().mark((function e(){return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,t.initializePromise;case 2:return e.next=4,t._autoRefreshTokenTick();case 4:case"end":return e.stop()}}),e)}))),0);case 7:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"_stopAutoRefresh",value:function(){var e=(0,o.Z)(c().mark((function e(){var r;return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:this._debug("#_stopAutoRefresh()"),r=this.autoRefreshTicker,this.autoRefreshTicker=null,r&&clearInterval(r);case 4:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"startAutoRefresh",value:function(){var e=(0,o.Z)(c().mark((function e(){return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this._removeVisibilityChangedCallback(),e.next=3,this._startAutoRefresh();case 3:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"stopAutoRefresh",value:function(){var e=(0,o.Z)(c().mark((function e(){return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this._removeVisibilityChangedCallback(),e.next=3,this._stopAutoRefresh();case 3:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"_autoRefreshTokenTick",value:function(){var e=(0,o.Z)(c().mark((function e(){var r=this;return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this._debug("#_autoRefreshTokenTick()","begin"),e.prev=1,e.next=4,this._acquireLock(0,(0,o.Z)(c().mark((function e(){var t;return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,t=Date.now(),e.prev=2,e.next=5,r._useSession(function(){var e=(0,o.Z)(c().mark((function e(n){var s,a;return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if((s=n.data.session)&&s.refresh_token&&s.expires_at){e.next=4;break}return r._debug("#_autoRefreshTokenTick()","no session"),e.abrupt("return");case 4:if(a=Math.floor((1e3*s.expires_at-t)/h.r6),r._debug("#_autoRefreshTokenTick()","access token expires in ".concat(a," ticks, a tick lasts ").concat(h.r6,"ms, refresh threshold is ").concat(h.Js," ticks")),!(a<=h.Js)){e.next=9;break}return e.next=9,r._callRefreshToken(s.refresh_token);case 9:case"end":return e.stop()}}),e)})));return function(r){return e.apply(this,arguments)}}());case 5:return e.abrupt("return",e.sent);case 8:e.prev=8,e.t0=e.catch(2),console.error("Auto refresh tick failed with error. This is likely a transient error.",e.t0);case 11:return e.prev=11,r._debug("#_autoRefreshTokenTick()","end"),e.finish(11);case 14:case"end":return e.stop()}}),e,null,[[0,,11,14],[2,8]])}))));case 4:e.next=13;break;case 6:if(e.prev=6,e.t0=e.catch(1),!(e.t0.isAcquireTimeout||e.t0 instanceof x.mL)){e.next=12;break}this._debug("auto refresh token tick lock not available"),e.next=13;break;case 12:throw e.t0;case 13:case"end":return e.stop()}}),e,this,[[1,6]])})));return function(){return e.apply(this,arguments)}}()},{key:"_handleVisibilityChange",value:function(){var e=(0,o.Z)(c().mark((function e(){var r=this;return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this._debug("#_handleVisibilityChange()"),(0,f.jU)()&&(null===window||void 0===window?void 0:window.addEventListener)){e.next=4;break}return this.autoRefreshToken&&this.startAutoRefresh(),e.abrupt("return",!1);case 4:return e.prev=4,this.visibilityChangedCallback=(0,o.Z)(c().mark((function e(){return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,r._onVisibilityChanged(!1);case 2:return e.abrupt("return",e.sent);case 3:case"end":return e.stop()}}),e)}))),null===window||void 0===window||window.addEventListener("visibilitychange",this.visibilityChangedCallback),e.next=9,this._onVisibilityChanged(!0);case 9:e.next=14;break;case 11:e.prev=11,e.t0=e.catch(4),console.error("_handleVisibilityChange",e.t0);case 14:case"end":return e.stop()}}),e,this,[[4,11]])})));return function(){return e.apply(this,arguments)}}()},{key:"_onVisibilityChanged",value:function(){var e=(0,o.Z)(c().mark((function e(r){var t,n=this;return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t="#_onVisibilityChanged(".concat(r,")"),this._debug(t,"visibilityState",document.visibilityState),"visible"!==document.visibilityState){e.next=11;break}if(this.autoRefreshToken&&this._startAutoRefresh(),r){e.next=9;break}return e.next=7,this.initializePromise;case 7:return e.next=9,this._acquireLock(-1,(0,o.Z)(c().mark((function e(){return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if("visible"===document.visibilityState){e.next=3;break}return n._debug(t,"acquired the lock to recover the session, but the browser visibilityState is no longer visible, aborting"),e.abrupt("return");case 3:return e.next=5,n._recoverAndRefresh();case 5:case"end":return e.stop()}}),e)}))));case 9:e.next=12;break;case 11:"hidden"===document.visibilityState&&this.autoRefreshToken&&this._stopAutoRefresh();case 12:case"end":return e.stop()}}),e,this)})));return function(r){return e.apply(this,arguments)}}()},{key:"_getUrlForProvider",value:function(){var e=(0,o.Z)(c().mark((function e(r,t,n){var a,i,o,u,l,h,p;return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(a=["provider=".concat(encodeURIComponent(t))],(null===n||void 0===n?void 0:n.redirectTo)&&a.push("redirect_to=".concat(encodeURIComponent(n.redirectTo))),(null===n||void 0===n?void 0:n.scopes)&&a.push("scopes=".concat(encodeURIComponent(n.scopes))),"pkce"!==this.flowType){e.next=12;break}return e.next=6,(0,f.__)(this.storage,this.storageKey);case 6:i=e.sent,o=(0,s.Z)(i,2),u=o[0],l=o[1],h=new URLSearchParams({code_challenge:"".concat(encodeURIComponent(u)),code_challenge_method:"".concat(encodeURIComponent(l))}),a.push(h.toString());case 12:return(null===n||void 0===n?void 0:n.queryParams)&&(p=new URLSearchParams(n.queryParams),a.push(p.toString())),(null===n||void 0===n?void 0:n.skipBrowserRedirect)&&a.push("skip_http_redirect=".concat(n.skipBrowserRedirect)),e.abrupt("return","".concat(r,"?").concat(a.join("&")));case 15:case"end":return e.stop()}}),e,this)})));return function(r,t,n){return e.apply(this,arguments)}}()},{key:"_unenroll",value:function(){var e=(0,o.Z)(c().mark((function e(r){var t=this;return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,this._useSession(function(){var e=(0,o.Z)(c().mark((function e(n){var s,a,i;return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(a=n.data,!(i=n.error)){e.next=3;break}return e.abrupt("return",{data:null,error:i});case 3:return e.next=5,(0,d.cY)(t.fetch,"DELETE","".concat(t.url,"/factors/").concat(r.factorId),{headers:t.headers,jwt:null===(s=null===a||void 0===a?void 0:a.session)||void 0===s?void 0:s.access_token});case 5:return e.abrupt("return",e.sent);case 6:case"end":return e.stop()}}),e)})));return function(r){return e.apply(this,arguments)}}());case 3:return e.abrupt("return",e.sent);case 6:if(e.prev=6,e.t0=e.catch(0),!(0,p.f1)(e.t0)){e.next=10;break}return e.abrupt("return",{data:null,error:e.t0});case 10:throw e.t0;case 11:case"end":return e.stop()}}),e,this,[[0,6]])})));return function(r){return e.apply(this,arguments)}}()},{key:"_enroll",value:function(){var e=(0,o.Z)(c().mark((function e(r){var t=this;return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,this._useSession(function(){var e=(0,o.Z)(c().mark((function e(n){var s,a,i,o,u,l,h,p;return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(i=n.data,!(o=n.error)){e.next=3;break}return e.abrupt("return",{data:null,error:o});case 3:return u=Object.assign({friendly_name:r.friendlyName,factor_type:r.factorType},"phone"===r.factorType?{phone:r.phone}:{issuer:r.issuer}),e.next=6,(0,d.cY)(t.fetch,"POST","".concat(t.url,"/factors"),{body:u,headers:t.headers,jwt:null===(s=null===i||void 0===i?void 0:i.session)||void 0===s?void 0:s.access_token});case 6:if(l=e.sent,h=l.data,!(p=l.error)){e.next=11;break}return e.abrupt("return",{data:null,error:p});case 11:return"totp"===r.factorType&&(null===(a=null===h||void 0===h?void 0:h.totp)||void 0===a?void 0:a.qr_code)&&(h.totp.qr_code="data:image/svg+xml;utf-8,".concat(h.totp.qr_code)),e.abrupt("return",{data:h,error:null});case 13:case"end":return e.stop()}}),e)})));return function(r){return e.apply(this,arguments)}}());case 3:return e.abrupt("return",e.sent);case 6:if(e.prev=6,e.t0=e.catch(0),!(0,p.f1)(e.t0)){e.next=10;break}return e.abrupt("return",{data:null,error:e.t0});case 10:throw e.t0;case 11:case"end":return e.stop()}}),e,this,[[0,6]])})));return function(r){return e.apply(this,arguments)}}()},{key:"_verify",value:function(){var e=(0,o.Z)(c().mark((function e(r){var t=this;return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this._acquireLock(-1,(0,o.Z)(c().mark((function e(){return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,t._useSession(function(){var e=(0,o.Z)(c().mark((function e(n){var s,a,i,o,u,l;return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(a=n.data,!(i=n.error)){e.next=3;break}return e.abrupt("return",{data:null,error:i});case 3:return e.next=5,(0,d.cY)(t.fetch,"POST","".concat(t.url,"/factors/").concat(r.factorId,"/verify"),{body:{code:r.code,challenge_id:r.challengeId},headers:t.headers,jwt:null===(s=null===a||void 0===a?void 0:a.session)||void 0===s?void 0:s.access_token});case 5:if(o=e.sent,u=o.data,!(l=o.error)){e.next=10;break}return e.abrupt("return",{data:null,error:l});case 10:return e.next=12,t._saveSession(Object.assign({expires_at:Math.round(Date.now()/1e3)+u.expires_in},u));case 12:return e.next=14,t._notifyAllSubscribers("MFA_CHALLENGE_VERIFIED",u);case 14:return e.abrupt("return",{data:u,error:l});case 15:case"end":return e.stop()}}),e)})));return function(r){return e.apply(this,arguments)}}());case 3:return e.abrupt("return",e.sent);case 6:if(e.prev=6,e.t0=e.catch(0),!(0,p.f1)(e.t0)){e.next=10;break}return e.abrupt("return",{data:null,error:e.t0});case 10:throw e.t0;case 11:case"end":return e.stop()}}),e,null,[[0,6]])})))));case 1:case"end":return e.stop()}}),e,this)})));return function(r){return e.apply(this,arguments)}}()},{key:"_challenge",value:function(){var e=(0,o.Z)(c().mark((function e(r){var t=this;return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this._acquireLock(-1,(0,o.Z)(c().mark((function e(){return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,t._useSession(function(){var e=(0,o.Z)(c().mark((function e(n){var s,a,i;return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(a=n.data,!(i=n.error)){e.next=3;break}return e.abrupt("return",{data:null,error:i});case 3:return e.next=5,(0,d.cY)(t.fetch,"POST","".concat(t.url,"/factors/").concat(r.factorId,"/challenge"),{body:{channel:r.channel},headers:t.headers,jwt:null===(s=null===a||void 0===a?void 0:a.session)||void 0===s?void 0:s.access_token});case 5:return e.abrupt("return",e.sent);case 6:case"end":return e.stop()}}),e)})));return function(r){return e.apply(this,arguments)}}());case 3:return e.abrupt("return",e.sent);case 6:if(e.prev=6,e.t0=e.catch(0),!(0,p.f1)(e.t0)){e.next=10;break}return e.abrupt("return",{data:null,error:e.t0});case 10:throw e.t0;case 11:case"end":return e.stop()}}),e,null,[[0,6]])})))));case 1:case"end":return e.stop()}}),e,this)})));return function(r){return e.apply(this,arguments)}}()},{key:"_challengeAndVerify",value:function(){var e=(0,o.Z)(c().mark((function e(r){var t,n,s;return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._challenge({factorId:r.factorId});case 2:if(t=e.sent,n=t.data,!(s=t.error)){e.next=7;break}return e.abrupt("return",{data:null,error:s});case 7:return e.next=9,this._verify({factorId:r.factorId,challengeId:n.id,code:r.code});case 9:return e.abrupt("return",e.sent);case 10:case"end":return e.stop()}}),e,this)})));return function(r){return e.apply(this,arguments)}}()},{key:"_listFactors",value:function(){var e=(0,o.Z)(c().mark((function e(){var r,t,n,s,a,i;return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.getUser();case 2:if(r=e.sent,t=r.data.user,!(n=r.error)){e.next=7;break}return e.abrupt("return",{data:null,error:n});case 7:return s=(null===t||void 0===t?void 0:t.factors)||[],a=s.filter((function(e){return"totp"===e.factor_type&&"verified"===e.status})),i=s.filter((function(e){return"phone"===e.factor_type&&"verified"===e.status})),e.abrupt("return",{data:{all:s,totp:a,phone:i},error:null});case 11:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"_getAuthenticatorAssuranceLevel",value:function(){var e=(0,o.Z)(c().mark((function e(){var r=this;return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this._acquireLock(-1,(0,o.Z)(c().mark((function e(){return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,r._useSession(function(){var e=(0,o.Z)(c().mark((function e(r){var t,n,s,a,i,o,u,l,h;return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(s=r.data.session,!(a=r.error)){e.next=3;break}return e.abrupt("return",{data:null,error:a});case 3:if(s){e.next=5;break}return e.abrupt("return",{data:{currentLevel:null,nextLevel:null,currentAuthenticationMethods:[]},error:null});case 5:return i=(0,f.xp)(s.access_token),o=i.payload,u=null,o.aal&&(u=o.aal),l=u,(null!==(n=null===(t=s.user.factors)||void 0===t?void 0:t.filter((function(e){return"verified"===e.status})))&&void 0!==n?n:[]).length>0&&(l="aal2"),h=o.amr||[],e.abrupt("return",{data:{currentLevel:u,nextLevel:l,currentAuthenticationMethods:h},error:null});case 13:case"end":return e.stop()}}),e)})));return function(r){return e.apply(this,arguments)}}());case 2:return e.abrupt("return",e.sent);case 3:case"end":return e.stop()}}),e)})))));case 1:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"fetchJwk",value:function(){var e=(0,o.Z)(c().mark((function e(r){var t,n,s,a,i=arguments;return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!(t=(i.length>1&&void 0!==i[1]?i[1]:{keys:[]}).keys.find((function(e){return e.kid===r})))){e.next=4;break}return e.abrupt("return",t);case 4:if(!((t=this.jwks.keys.find((function(e){return e.kid===r})))&&this.jwks_cached_at+h.Kd>Date.now())){e.next=7;break}return e.abrupt("return",t);case 7:return e.next=9,(0,d.cY)(this.fetch,"GET","".concat(this.url,"/.well-known/jwks.json"),{headers:this.headers});case 9:if(n=e.sent,s=n.data,!(a=n.error)){e.next=14;break}throw a;case 14:if(s.keys&&0!==s.keys.length){e.next=16;break}throw new p.UQ("JWKS is empty");case 16:if(this.jwks=s,this.jwks_cached_at=Date.now(),t=s.keys.find((function(e){return e.kid===r}))){e.next=21;break}throw new p.UQ("No matching signing key found in JWKS");case 21:return e.abrupt("return",t);case 22:case"end":return e.stop()}}),e,this)})));return function(r){return e.apply(this,arguments)}}()},{key:"getClaims",value:function(){var e=(0,o.Z)(c().mark((function e(r){var t,n,s,a,i,o,u,l,h,d,v,b,k,x,_,g,y,m=arguments;return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t=m.length>1&&void 0!==m[1]?m[1]:{keys:[]},e.prev=1,n=r){e.next=12;break}return e.next=6,this.getSession();case 6:if(s=e.sent,a=s.data,!(i=s.error)&&a.session){e.next=11;break}return e.abrupt("return",{data:null,error:i});case 11:n=a.session.access_token;case 12:if(o=(0,f.xp)(n),u=o.header,l=o.payload,h=o.signature,d=o.raw,v=d.header,b=d.payload,(0,f.RZ)(l.exp),u.kid&&"HS256"!==u.alg&&"crypto"in globalThis&&"subtle"in globalThis.crypto){e.next=22;break}return e.next=17,this.getUser(n);case 17:if(k=e.sent,!(x=k.error)){e.next=21;break}throw x;case 21:return e.abrupt("return",{data:{claims:l,header:u,signature:h},error:null});case 22:return _=(0,f.Z2)(u.alg),e.next=25,this.fetchJwk(u.kid,t);case 25:return g=e.sent,e.next=28,crypto.subtle.importKey("jwk",g,_,!0,["verify"]);case 28:return y=e.sent,e.next=31,crypto.subtle.verify(_,y,h,(0,w.sy)("".concat(v,".").concat(b)));case 31:if(e.sent){e.next=34;break}throw new p.UQ("Invalid JWT signature");case 34:return e.abrupt("return",{data:{claims:l,header:u,signature:h},error:null});case 37:if(e.prev=37,e.t0=e.catch(1),!(0,p.f1)(e.t0)){e.next=41;break}return e.abrupt("return",{data:null,error:e.t0});case 41:throw e.t0;case 42:case"end":return e.stop()}}),e,this,[[1,37]])})));return function(r){return e.apply(this,arguments)}}()}]),e}();m.nextInstanceID=0}}]);